<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock Heatmap + Candlestick</title>

  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-2.33.0.min.js"></script>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background: #f4f6f9;
    }
    h1 { text-align: center; color: #2c3e50; }

    .controls {
      text-align: center;
      margin: 20px 0;
    }
    .controls input {
      padding: 8px 12px;
      font-size: 16px;
      width: 120px;
    }
    .controls button {
      padding: 8px 16px;
      font-size: 16px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .controls button:hover { background: #2980b9; }

    .chart-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }
    .chart {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
    }
    #candleChart { width: 100%; height: 500px; flex: 2; min-width: 600px; }
    #heatmap { flex: 1; min-width: 400px; height: 500px; }

    .tile {
      cursor: pointer;
      stroke: #fff;
      stroke-width: 1.5px;
      transition: stroke 0.2s;
    }
    .tile:hover {
      stroke: #000;
      stroke-width: 3px;
    }

    #tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 1000;
    }

    .legend {
      margin-top: 10px;
      font-size: 12px;
    }
    .legend rect {
      stroke: #ccc;
    }
  </style>
</head>
<body>

<h1>Real-Time Stock Heatmap & Candlestick</h1>

<div class="controls">
  <input id="symbolInput" type="text" placeholder="e.g. AAPL" value="AAPL" />
  <button id="loadSingle">Load Candle</button>
  <button id="refreshHeatmap">Refresh Heatmap</button>
</div>

<div class="chart-container">
  <div id="candleChart" class="chart"></div>
  <div id="heatmap" class="chart"></div>
</div>

<div id="tooltip"></div>

<script>
/* ==============================================================
   1. API Helpers
   ============================================================== */
const API_BASE = ''; // same origin

async function fetchAllHeatmap() {
  const resp = await fetch(`${API_BASE}/heatmap/all`);
  if (!resp.ok) throw new Error('Failed to fetch heatmap data');
  return resp.json(); // → List<HeatMapDto>
}

async function fetchCandle(symbol) {
  const resp = await fetch(`${API_BASE}/candle?symbol=${symbol}`);
  if (!resp.ok) throw new Error('Failed to fetch candle data');
  return resp.json(); // → StockCandleDto
}

/* ==============================================================
   2. Plotly Candlestick
   ============================================================== */
async function drawCandles(dto) {
  const trace = {
    x: dto.ohlcvs.map(o => o.date),
    open: dto.ohlcvs.map(o => o.open),
    high: dto.ohlcvs.map(o => o.high),
    low: dto.ohlcvs.map(o => o.low),
    close: dto.ohlcvs.map(o => o.close),
    type: 'candlestick',
    increasing: { line: { color: '#27ae60' } },
    decreasing: { line: { color: '#e74c3c' } }
  };

  const layout = {
    title: `<b>${dto.symbol}</b> – ${dto.companyName}<br>Market Cap: $${(dto.marketCap/1e9).toFixed(2)}B`,
    xaxis: { title: 'Date', rangeslider: { visible: false } },
    yaxis: { title: 'Price ($)' },
    margin: { l: 50, r: 40, t: 80, b: 50 },
    hovermode: 'x unified'
  };

  Plotly.react('candleChart', [trace], layout, { responsive: true });
}

/* ==============================================================
   3. D3 Heatmap (Grid of Symbols)
   ============================================================== */
const margin = { top: 50, right: 30, bottom: 80, left: 60 };
const width = 500 - margin.left - margin.right;
const height = 450 - margin.top - margin.bottom;

let svg, gTiles, xScale, yScale, colorScale;

function initHeatmap() {
  svg = d3.select('#heatmap')
    .append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom);

  const g = svg.append('g')
    .attr('transform', `translate(${margin.left},${margin.top})`);

  gTiles = g.append('g');
  svg.append('g').attr('class', 'x-axis')
    .attr('transform', `translate(${margin.left},${height + margin.top})`);
  svg.append('g').attr('class', 'y-axis')
    .attr('transform', `translate(${margin.left},${margin.top})`);

  // Color legend
  const legend = svg.append('g')
    .attr('class', 'legend')
    .attr('transform', `translate(${margin.left},${height + margin.top + 50})`);

  const grad = svg.append('defs')
    .append('linearGradient')
    .attr('id', 'grad')
    .attr('x1', '0%').attr('y1', '0%')
    .attr('x2', '100%').attr('y2', '0%');

  grad.append('stop').attr('offset', '0%').attr('stop-color', '#e74c3c');
  grad.append('stop').attr('offset', '50%').attr('stop-color', '#f1c40f');
  grad.append('stop').attr('offset', '100%').attr('stop-color', '#27ae60');

  legend.append('rect')
    .attr('width', 200).attr('height', 15)
    .style('fill', 'url(#grad)');

  ['-10%', '0%', '+10%'].forEach((txt, i) => {
    legend.append('text')
      .attr('x', i * 100)
      .attr('y', -5)
      .attr('text-anchor', i === 1 ? 'middle' : (i === 0 ? 'start' : 'end'))
      .text(txt);
  });
}

function drawHeatmap(data) {
  // Sort by % change (optional)
  data.sort((a, b) => (b.marketPriceChgPct || 0) - (a.marketPriceChgPct || 0));

  const symbols = data.map(d => d.symbol);
  const tileSize = 50;
  const cols = Math.floor(width / (tileSize + 10));
  const rows = Math.ceil(symbols.length / cols);

  // Adjust height dynamically
  const totalHeight = rows * (tileSize + 10) + 50;
  d3.select('#heatmap svg').attr('height', totalHeight + margin.top + margin.bottom + 80);

  xScale = d3.scaleBand()
    .domain(d3.range(cols))
    .range([0, width])
    .padding(0.1);

  yScale = d3.scaleBand()
    .domain(d3.range(rows))
    .range([0, totalHeight - 100])
    .padding(0.1);

  colorScale = d3.scaleLinear()
    .domain([-10, 0, 10])
    .range(['#e74c3c', '#f1c40f', '#27ae60'])
    .clamp(true);

  // Bind data
  const tiles = gTiles.selectAll('.tile')
    .data(data, d => d.symbol);

  // Enter
  const enter = tiles.enter()
    .append('g')
    .attr('class', 'tile')
    .on('click', (event, d) => {
      document.getElementById('symbolInput').value = d.symbol;
      loadCandleForSymbol(d.symbol);
    });

  enter.append('rect');
  enter.append('text')
    .attr('text-anchor', 'middle')
    .attr('dy', '.35em')
    .style('font-size', '11px')
    .style('font-weight', 'bold')
    .style('pointer-events', 'none');

  enter.append('text')
    .attr('class', 'pct')
    .attr('text-anchor', 'middle')
    .attr('dy', '1.3em')
    .style('font-size', '10px')
    .style('fill', '#333')
    .style('pointer-events', 'none');

  // Update + Enter
  tiles.merge(enter)
    .attr('transform', (d, i) => {
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x = xScale(col);
      const y = yScale(row);
      return `translate(${x},${y})`;
    });

  tiles.select('rect')
    .transition().duration(500)
    .attr('width', xScale.bandwidth())
    .attr('height', yScale.bandwidth())
    .style('fill', d => colorScale(d.marketPriceChgPct || 0));

  tiles.select('text')
    .text(d => d.symbol)
    .attr('x', d => xScale.bandwidth() / 2)
    .attr('y', d => yScale.bandwidth() / 2);

  tiles.select('text.pct')
    .text(d => `${d.marketPriceChgPct?.toFixed(1)}%` || 'N/A')
    .attr('x', d => xScale.bandwidth() / 2)
    .attr('y', d => yScale.bandwidth() / 2 + 12);

  // Tooltip
  tiles
    .on('mouseover', (event, d) => {
      const tip = d3.select('#tooltip')
        .style('opacity', 1)
        .html(`
          <strong>${d.symbol}</strong><br/>
          Price: $${d.price?.toFixed(2)}<br/>
          Δ: ${d.marketPriceChg?.toFixed(2)} (${d.marketPriceChgPct?.toFixed(2)}%)<br/>
          <em>Click for chart</em>
        `);
      tip.style('left', (event.pageX + 10) + 'px')
         .style('top', (event.pageY - 10) + 'px');
    })
    .on('mouseout', () => d3.select('#tooltip').style('opacity', 0));

  // Exit
  tiles.exit().remove();
}

/* ==============================================================
   4. Load & Refresh Logic
   ============================================================== */
async function loadHeatmap() {
  try {
    const data = await fetchAllHeatmap();
    drawHeatmap(data);
  } catch (e) {
    console.error(e);
    alert('Failed to load heatmap data');
  }
}

async function loadCandleForSymbol(symbol) {
  try {
    const data = await fetchCandle(symbol);
    drawCandles(data);
  } catch (e) {
    console.error(e);
    alert(`No candle data for ${symbol}`);
  }
}

/* ==============================================================
   5. Event Listeners
   ============================================================== */
document.getElementById('loadSingle').addEventListener('click', () => {
  const sym = document.getElementById('symbolInput').value.trim().toUpperCase();
  if (sym) loadCandleForSymbol(sym);
});

document.getElementById('refreshHeatmap').addEventListener('click', loadHeatmap);

/* ==============================================================
   6. Auto-refresh heatmap every 30s
   ============================================================== */
let refreshInterval = setInterval(loadHeatmap, 30_000);

/* ==============================================================
   7. Init
   ============================================================== */
initHeatmap();
loadHeatmap(); // initial load
loadCandleForSymbol('AAPL'); // default chart

</script>

</body>
</html>